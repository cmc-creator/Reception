import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  setDoc, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  writeBatch 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- HOLOGRAPHIC COMPONENT SUITE (Top-level definition to prevent ReferenceErrors) ---
const CalendarIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00f3ff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ filter: 'drop-shadow(0 0 5px #00f3ff)' }}>
    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
  </svg>
);

const SyncIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00f3ff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
  </svg>
);

const PersonnelIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ filter: 'drop-shadow(0 0 5px #ff00ff)' }}>
    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
  </svg>
);

const PlusIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00f3ff" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
  </svg>
);

const TrashIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ff0055" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
  </svg>
);

const AlertIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ff0000" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ filter: 'drop-shadow(0 0 8px #ff0000)' }}>
    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
  </svg>
);

const LockIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
);

const SendIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
);

const ActivityIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
  </svg>
);

const TerminalIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00f3ff" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
);

const ChevronLeftIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
);

const ChevronRightIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
);

// --- INITIALIZATION ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'destiny-springs-hub';

const PRESET_COLORS = [
  { bg: 'bg-cyan-600/80', glow: 'shadow-[0_0_12px_#0891b2]', text: 'text-cyan-400' }, 
  { bg: 'bg-rose-600/80', glow: 'shadow-[0_0_12px_#e11d48]', text: 'text-rose-400' },
  { bg: 'bg-fuchsia-600/80', glow: 'shadow-[0_0_12px_#c026d3]', text: 'text-fuchsia-400' },
  { bg: 'bg-blue-600/80', glow: 'shadow-[0_0_12px_#2563eb]', text: 'text-blue-400' }, 
  { bg: 'bg-emerald-600/80', glow: 'shadow-[0_0_12px_#10b981]', text: 'text-emerald-400' }
];

const TRIVIA_SET = [
  { q: "Which planet is known as the Gas Giant?", a: "Jupiter" },
  { q: "Capital of Arizona?", a: "Phoenix" },
  { q: "Symbol for Gold?", a: "Au" },
  { q: "What is 15 multiplied by 4?", a: "60" }
];

const REPORT_FIELDS = [
  { id: 'mail', label: 'Mail / Deliveries' }, 
  { id: 'property', label: 'Patient Property' },
  { id: 'supplies', label: 'Hub Inventory' }, 
  { id: 'lobby', label: 'Lobby Protocol' }, 
  { id: 'aoc', label: 'AOC Status' }
];

const App = () => {
  const [user, setUser] = useState(null);
  const [currentDate, setCurrentDate] = useState(new Date(2026, 1, 1)); 
  const [selectedDate, setSelectedDate] = useState(() => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  });
  
  const [events, setEvents] = useState({});
  const [staff, setStaff] = useState({});
  const [messages, setMessages] = useState([]);
  const [reportData, setReportData] = useState({});
  const [trivia, setTrivia] = useState({ index: 0, score: 0 });
  const [globalAlert, setGlobalAlert] = useState('');
  
  const [isPersonnelModalOpen, setIsPersonnelModalOpen] = useState(false);
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);
  const [editingShift, setEditingShift] = useState(null);
  const [newStaffName, setNewStaffName] = useState('');
  const [newStaffColor, setNewStaffColor] = useState(PRESET_COLORS[0].bg);
  const [chatInput, setChatInput] = useState('');
  const [newShiftTime, setNewShiftTime] = useState('08:00');
  const [triviaInput, setTriviaInput] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const [adminCode, setAdminCode] = useState('');
  const [isAdminAuth, setIsAdminAuth] = useState(false);

  const chatEndRef = useRef(null);

  // --- Handlers ---
  const handleMasterReset = async () => {
    if (!user) return;
    if (!confirm("ADMIN MASTER RESET: Restore Core Manifest and February Baseline? This will fix your staff list and schedule.")) return;
    
    setIsSaving(true);
    const batch = writeBatch(db);
    
    // Core Personnel Baseline - Explicitly hardcoded to fix "missing staff" issue
    const coreTeam = [
      { id: 'baseline-karen', name: 'Karen', bg: 'bg-cyan-600/80', notes: 'System Lead' }, 
      { id: 'baseline-izzy', name: 'Izzy', bg: 'bg-rose-600/80', notes: 'Hub Specialist' },
      { id: 'baseline-annalissia', name: 'Annalissia', bg: 'bg-fuchsia-600/80', notes: 'Support Unit' }, 
      { id: 'baseline-hal', name: 'Hal', bg: 'bg-blue-600/80', notes: 'Lead Unit' }
    ];

    for (const member of coreTeam) {
      const ref = doc(db, 'artifacts', appId, 'public', 'data', 'staff', member.id);
      batch.set(ref, { 
        name: member.name, 
        bg: member.bg, 
        notes: member.notes, 
        createdAt: Date.now() 
      }, { merge: true });
    }

    // Deploy February 2026 Patterns
    for (let d = 1; d <= 28; d++) {
      const dk = `2026-02-${String(d).padStart(2, '0')}`;
      const dow = new Date(2026, 1, d).getDay();
      
      if (dow === 1 || dow === 3) {
        batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'shifts')), { date: dk, empId: 'baseline-karen', time: '08:00', confirmed: true, createdAt: Date.now() });
      } else if (dow === 2 || dow === 4 || dow === 5) {
        batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'shifts')), { date: dk, empId: 'baseline-izzy', time: '08:00', confirmed: true, createdAt: Date.now() });
      } else if (dow === 0 && d === 1) {
        batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'shifts')), { date: dk, empId: 'baseline-hal', time: '16:00', confirmed: true, createdAt: Date.now() });
        batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'shifts')), { date: dk, empId: 'baseline-annalissia', time: '08:00', confirmed: true, createdAt: Date.now() });
      }
    }

    await batch.commit(); 
    setIsSaving(false);
  };

  const handleTriviaSubmit = (e) => {
    e.preventDefault();
    if (!user) return;
    const correct = TRIVIA_SET[trivia.index || 0].a.toLowerCase().trim();
    if (triviaInput.toLowerCase().trim() === correct) {
      setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trivia', 'shared'), { index: (trivia.index + 1) % TRIVIA_SET.length, score: (trivia.score || 0) + 1 });
      setTriviaInput('');
    }
  };

  const handleSendChat = async (e) => {
    e.preventDefault();
    if (!chatInput.trim() || !user) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
      text: chatInput, createdAt: Date.now(), user: user.uid.slice(-4)
    });
    setChatInput('');
  };

  const handleAssignShift = async (empId) => {
    if (!user || !selectedDate || !empId) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'shifts'), {
      date: selectedDate, empId, time: newShiftTime, confirmed: true, createdAt: Date.now()
    });
    setIsAddModalOpen(false);
  };

  const updateReport = async (f, v) => {
    if (!user || !selectedDate) return;
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dailyReports', selectedDate), { ...reportData, [f]: v }, { merge: true });
  };

  const verifyAdmin = (e) => {
    e.preventDefault();
    if (adminCode === '2026') { setIsAdminAuth(true); setAdminCode(''); }
  };

  // --- Firebase Sync ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Handshake Fail", err); }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const err = (e) => console.error("Sync Failure", e);

    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'shifts'), snap => {
      const d = {}; snap.forEach(doc => { const s = doc.data(); if(!d[s.date]) d[s.date] = []; d[s.date].push({...s, id: doc.id}); });
      setEvents(d);
    }, err);

    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'staff'), snap => {
      const l = {}; snap.forEach(doc => l[doc.id] = {...doc.data(), id: doc.id}); setStaff(l);
    }, err);

    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), snap => {
      const msgs = []; snap.forEach(doc => msgs.push({...doc.data(), id: doc.id}));
      setMessages(msgs.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0)));
      chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, err);

    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'trivia', 'shared'), snap => {
      if (snap.exists()) setTrivia(snap.data());
    }, err);

    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'alerts', 'current'), snap => {
      if (snap.exists()) setGlobalAlert(snap.data().text);
    }, err);
  }, [user]);

  useEffect(() => {
    if (!user || !selectedDate) return;
    const uReport = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'dailyReports', selectedDate), snap => {
      if (snap.exists()) setReportData(snap.data());
      else setReportData({ status: 'ACTIVE' });
    });
    return () => uReport();
  }, [user, selectedDate]);

  // --- Render Helpers ---
  const matrixCells = useMemo(() => {
    const monthIndex = currentDate.getMonth();
    const yearIndex = currentDate.getFullYear();
    const daysInMonth = new Date(yearIndex, monthIndex + 1, 0).getDate();
    const firstDay = new Date(yearIndex, monthIndex, 1).getDay();
    const cells = [];
    
    for (let i = 0; i < firstDay; i++) cells.push(<div key={`empty-${i}`} className="min-h-[110px] bg-white/[0.01] border border-white/[0.03]" />);
    
    for (let d = 1; d <= daysInMonth; d++) {
      const dk = `${yearIndex}-${String(monthIndex + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
      const shifts = events[dk] || [];
      const isToday = new Date().toISOString().split('T')[0] === dk;
      cells.push(
        <div key={dk} onClick={() => setSelectedDate(dk)} className={`min-h-[110px] p-2 border border-white/[0.05] transition-all cursor-pointer relative group ${selectedDate === dk ? 'bg-cyan-500/10 ring-1 ring-cyan-400 shadow-[inset_0_0_15px_rgba(0,243,255,0.1)]' : 'bg-white/[0.01] hover:bg-white/[0.03]'} ${isToday ? 'border-l-2 border-l-cyan-400' : ''}`}>
          <div className="flex justify-between items-start mb-1">
            <span className={`text-lg font-black tracking-tighter ${selectedDate === dk ? 'text-cyan-400' : 'text-slate-600'}`}>{d}</span>
            <button onClick={(e) => { e.stopPropagation(); setSelectedDate(dk); setIsAddModalOpen(true); }} className="p-1 opacity-100 group-hover:scale-125 transition-transform"><PlusIcon /></button>
          </div>
          <div className="space-y-1">
            {shifts.length === 0 ? (
              <div className="text-[7px] font-black text-rose-500 flex items-center gap-1 mt-2 animate-pulse uppercase tracking-widest"><AlertIcon /> Needs Coverage!</div>
            ) : (
              shifts.map(s => (
                <div key={s.id} onClick={(e) => { e.stopPropagation(); setEditingShift(s); }} className={`p-1 px-2 rounded-sm text-[10px] font-black text-white shadow-lg ${staff[s.empId]?.bg || 'bg-slate-700'} uppercase flex items-center gap-1`}>
                  <span className="truncate flex-1 text-left">{staff[s.empId]?.name || '...'}</span>
                  <span className="opacity-50 font-mono text-[8px]">{s.time}</span>
                </div>
              ))
            )}
          </div>
        </div>
      );
    }
    return cells;
  }, [currentDate, events, selectedDate, staff]);

  if (!user) return <div className="h-screen bg-black flex items-center justify-center text-cyan-400 font-black animate-pulse uppercase tracking-[0.5em]">Establishing Matrix Link...</div>;

  return (
    <div className="app-container" style={{ display: 'flex', height: '100vh', width: '100vw', background: '#000', color: '#fff' }}>
      <style>{`
        * { font-style: normal !important; scrollbar-width: none; }
        ::-webkit-scrollbar { display: none; }
        body { font-family: 'Inter', sans-serif; background: #000; overflow: hidden; }
        .glass-panel { background: rgba(255,255,255,0.02); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; }
        .neon-blue { border: 1px solid rgba(0, 243, 255, 0.4); box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.05); }
        .neon-fuchsia { border: 1px solid rgba(255, 0, 255, 0.4); box-shadow: inset 0 0 20px rgba(255, 0, 255, 0.05); }
        .holo-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        .alert-pulse { animation: alert-glow-keyframes 2s infinite; }
        .status-pulse { animation: status-glow-keyframes 1.5s infinite; }
        @keyframes alert-glow-keyframes { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        @keyframes status-glow-keyframes { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
      `}</style>

      {/* Nav Rail */}
      <nav className="no-print" style={{ width: '64px', background: '#050505', borderRight: '1px solid rgba(255,255,255,0.05)', display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '24px 0', zIndex: 50 }}>
        <div className="text-cyan-400 font-black text-xl mb-12 shadow-[0_0_15px_#00f3ff]">DS</div>
        <div className="flex flex-col gap-10">
          <button onClick={handleMasterReset} title="Admin Master Reset" className="p-3 bg-cyan-500/10 rounded-xl border border-cyan-500/30 hover:scale-110 transition-all shadow-[0_0_15px_rgba(0,243,255,0.2)]"><SyncIcon /></button>
          <button onClick={() => setIsPersonnelModalOpen(true)} title="Personnel Hub" className="p-3 bg-fuchsia-500/10 rounded-xl border border-fuchsia-500/30 hover:scale-110 transition-all"><PersonnelIcon /></button>
          <button className="p-3 opacity-20"><CalendarIcon /></button>
        </div>
        <div className="mt-auto flex flex-col items-center gap-4">
           <div className={`w-2.5 h-2.5 rounded-full status-pulse ${user ? 'bg-emerald-500 shadow-[0_0_10px_#10b981]' : 'bg-amber-500 shadow-[0_0_10px_#f59e0b]'}`} title={user ? 'System Live' : 'Connecting...'} />
           <div className="opacity-10 text-[8px] font-black uppercase rotate-90 tracking-widest">Protocol</div>
        </div>
      </nav>

      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Urgent Intel Header */}
        <div className="no-print h-10 bg-rose-950/20 border-b border-rose-500/30 flex items-center px-6 gap-4 text-left">
           <div className="flex items-center gap-2 text-rose-500 font-black text-[9px] uppercase tracking-widest alert-pulse shrink-0">
             <AlertIcon /> Critical Intel
           </div>
           <input 
              value={globalAlert} 
              onChange={e => { setGlobalAlert(e.target.value); setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alerts', 'current'), { text: e.target.value }); }}
              className="flex-1 bg-transparent border-none text-[11px] font-bold text-white outline-none placeholder-rose-900"
              placeholder="Broadcast immediate hub directive..."
           />
        </div>

        <div className="flex-1 flex overflow-hidden">
          {/* SIDEBAR: INTEL FEED */}
          <aside className="no-print flex flex-col gap-4 p-5 overflow-y-auto border-r border-white/5" style={{ width: '330px', background: '#080808' }}>
            <header className="mb-2 text-left">
              <h1 className="text-lg font-black text-white tracking-tighter holo-text uppercase">Archive Logs</h1>
              <div className="text-[10px] text-cyan-400 font-bold uppercase mt-1 tracking-widest">{selectedDate}</div>
            </header>
            
            <div className="space-y-3">
              {REPORT_FIELDS.map(f => (
                <div key={f.id} className="glass-panel neon-fuchsia p-3">
                  <label className="text-[9px] font-black text-fuchsia-400 uppercase tracking-widest mb-1 block flex items-center gap-2"><ActivityIcon /> {f.label}</label>
                  <textarea 
                    value={String(reportData[f.id] || '')} 
                    onChange={e => updateReport(f.id, e.target.value)}
                    className="w-full bg-transparent border-none text-xs text-white h-10 outline-none resize-none font-bold placeholder-slate-800" 
                    placeholder="Log intel node..." 
                  />
                </div>
              ))}
            </div>

            <div className="glass-panel neon-blue p-3 rounded-lg mt-auto text-left flex flex-col h-48">
               <label className="text-[9px] font-black text-cyan-400 uppercase tracking-widest mb-2 block">Live Intel Feed</label>
               <div className="flex-1 overflow-y-auto space-y-1.5 mb-2 pr-1 no-scrollbar text-white">
                  {messages.map(m => (
                    <div key={m.id} className="text-[10px] leading-tight">
                       <span className="text-cyan-500 font-black uppercase mr-1">{m.user}:</span>
                       <span className="text-slate-300 font-medium">{m.text}</span>
                    </div>
                  ))}
                  <div ref={chatEndRef} />
               </div>
               <form onSubmit={handleSendChat} className="flex gap-1 shrink-0">
                  <input value={chatInput} onChange={e => setChatInput(e.target.value)} className="flex-1 bg-black border border-cyan-500/30 rounded p-1.5 text-[10px] outline-none text-white font-bold" placeholder="Broadcast..." />
                  <button type="submit" className="bg-cyan-600 px-2 rounded text-white shadow-lg"><SendIcon /></button>
               </form>
            </div>
          </aside>

          {/* MAIN MATRIX DISPLAY */}
          <main className="flex-1 p-8 overflow-y-auto bg-black no-scrollbar">
            <div className="flex justify-between items-end mb-8 no-print text-white">
               <div className="text-left">
                  <h2 className="text-5xl font-black uppercase tracking-tighter drop-shadow-[0_0_15px_rgba(255,255,255,0.2)]">
                    {currentDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' })}
                  </h2>
                  <div className="text-[10px] font-black text-cyan-400 tracking-[0.5em] uppercase mt-1">Matrix Interface Alpha</div>
               </div>
               <div className="flex gap-4">
                  <div className="flex bg-white/5 rounded-xl border border-white/10 p-1">
                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 hover:text-cyan-400 transition-colors border-r border-white/5"><ChevronLeftIcon /></button>
                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 hover:text-cyan-400 transition-colors"><ChevronRightIcon /></button>
                  </div>
                  <button onClick={() => window.print()} className="bg-cyan-500 text-black px-6 py-2 rounded-xl font-black text-xs uppercase shadow-[0_0_15px_rgba(0,243,255,0.4)] hover:bg-white transition-all">Export Matrix</button>
               </div>
            </div>

            <div className="grid grid-cols-7 glass-panel overflow-hidden neon-blue rounded-xl">
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="py-4 text-center text-[10px] font-black text-cyan-400/60 uppercase tracking-widest border-b border-white/5 bg-white/[0.02]">{day}</div>
              ))}
              {matrixCells}
            </div>

            {/* TERMINAL CHALLENGE */}
            <div className="mt-8 text-left glass-panel neon-blue p-5 flex items-center justify-between">
               <div className="flex-1">
                  <h3 className="text-[10px] font-black text-cyan-400 uppercase tracking-widest mb-2 flex items-center gap-2"><TerminalIcon /> Terminal Challenge</h3>
                  <p className="text-sm font-black text-slate-300">{TRIVIA_SET[trivia.index || 0].q}</p>
               </div>
               <form onSubmit={handleTriviaSubmit} className="flex gap-2 w-64">
                  <input value={triviaInput} onChange={e => setTriviaInput(e.target.value)} className="flex-1 bg-black border border-cyan-500/40 rounded-xl p-3 text-sm outline-none text-cyan-400 font-mono shadow-inner" placeholder="Decrypt..." />
                  <button type="submit" className="bg-cyan-600 px-6 rounded-xl font-black text-xs text-white">OK</button>
               </form>
            </div>
          </main>
        </div>
      </div>

      {/* ADMIN PERSONNEL HUB MODAL */}
      {isPersonnelModalOpen && (
        <div className="fixed inset-0 bg-black/98 backdrop-blur-2xl z-[600] flex items-center justify-center p-4">
          <div className="glass-panel neon-fuchsia p-10 w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl rounded-[2rem]">
            <div className="flex justify-between items-center mb-8 text-fuchsia-400 text-left">
               <h3 className="text-3xl font-black uppercase tracking-tighter">Manifest Editor</h3>
               <button onClick={() => { setIsPersonnelModalOpen(false); setIsAdminAuth(false); }} className="text-5xl font-light hover:text-white transition-colors">&times;</button>
            </div>

            {!isAdminAuth ? (
              <form onSubmit={verifyAdmin} className="space-y-6 flex-1 flex flex-col justify-center items-center text-center">
                 <div className="space-y-2 text-center">
                    <div className="text-fuchsia-500 font-black text-xl flex items-center gap-3 justify-center alert-pulse"><LockIcon /> Access Restricted</div>
                    <p className="text-slate-500 text-[10px] uppercase font-bold tracking-[0.3em]">Enter Override to Link Core Manifest</p>
                 </div>
                 <input 
                    type="password"
                    value={adminCode}
                    onChange={e => setAdminCode(e.target.value)}
                    className="w-48 bg-black border border-fuchsia-500/40 rounded-xl p-4 text-center text-3xl text-white font-black tracking-[0.5em] outline-none"
                    placeholder="****"
                    autoFocus
                 />
                 <button type="submit" className="bg-fuchsia-600 px-12 py-3 rounded-xl font-black uppercase text-xs shadow-lg hover:scale-105 transition-transform text-white">Unlock Manifest</button>
              </form>
            ) : (
              <div className="flex flex-col flex-1 overflow-hidden text-left">
                <div className="space-y-4 mb-8">
                  <label className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] block">Enroll New Unit</label>
                  <div className="flex gap-3">
                    <input value={newStaffName} onChange={e => setNewStaffName(e.target.value)} className="flex-1 bg-black border border-white/10 rounded-xl p-3 text-sm text-white font-black outline-none focus:border-fuchsia-500" placeholder="Identity Label..." />
                    <div className="flex gap-2">
                       {PRESET_COLORS.map(c => <button key={c.bg} onClick={() => setNewStaffColor(c.bg)} className={`w-8 h-8 rounded-lg ${c.bg} ${newStaffColor === c.bg ? 'ring-2 ring-white shadow-xl scale-110' : 'opacity-40'}`} />)}
                    </div>
                    <button onClick={async () => { if (!newStaffName.trim()) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'staff'), { name: newStaffName.trim(), bg: newStaffColor, createdAt: Date.now() }); setNewStaffName(''); }} className="bg-fuchsia-600 px-6 rounded-xl font-black uppercase text-xs text-white shadow-lg">Enroll</button>
                  </div>
                </div>

                <div className="flex-1 overflow-y-auto no-scrollbar space-y-2 pr-2 border-t border-white/5 pt-4">
                  {Object.values(staff).map(s => (
                    <div key={s.id} className="flex items-center justify-between p-3 glass-panel neon-blue rounded-xl group border-white/5">
                      <div className="flex items-center gap-4">
                        <div className={`w-3 h-3 rounded-full ${s.bg} shadow-white/20`} />
                        <div className="flex flex-col text-left">
                          <span className="font-black uppercase text-sm text-white tracking-tight">{s.name}</span>
                          <span className="text-[7px] text-slate-600 font-bold uppercase tracking-widest">Linked: {new Date(s.createdAt || Date.now()).toLocaleDateString()}</span>
                        </div>
                      </div>
                      <button onClick={async () => { if(confirm("Terminate unit identifier?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', s.id)); }} className="text-rose-500 font-black text-[9px] uppercase px-3 py-1 hover:bg-rose-500/10 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 border border-rose-500/30">
                        <TrashIcon /> Purge
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* DEPLOY MODAL (Assign Shift) */}
      {isAddModalOpen && (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[500] flex items-center justify-center p-4">
          <div className="glass-panel neon-blue p-10 w-full max-w-md shadow-2xl rounded-3xl text-left">
            <h3 className="text-2xl font-black text-cyan-400 uppercase mb-8 tracking-tighter">Deploy Identity</h3>
            <div className="grid grid-cols-2 gap-2 mb-8">
               {Object.values(staff).map(s => (
                 <button key={s.id} onClick={() => handleAssignShift(s.id)} className={`p-4 rounded-xl text-[10px] font-black uppercase text-white ${s.bg} hover:scale-105 transition-transform shadow-lg`}>{s.name}</button>
               ))}
            </div>
            <div className="space-y-4">
              <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block text-center">Sync Protocol Time</label>
              <input type="time" value={newShiftTime} onChange={e => setNewShiftTime(e.target.value)} className="w-full bg-black border border-cyan-500/30 rounded-2xl p-5 text-4xl text-white font-black text-center outline-none focus:border-cyan-400 shadow-inner" />
              <button onClick={() => setIsAddModalOpen(false)} className="w-full text-slate-600 text-[10px] font-black uppercase tracking-[0.2em] hover:text-white transition-colors pt-6 text-center">Abort Sequence</button>
            </div>
          </div>
        </div>
      )}

      {/* MODIFY NODE MODAL (Edit Shift) */}
      {editingShift && (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[500] flex items-center justify-center p-4 text-left">
          <div className="glass-panel neon-fuchsia p-8 w-full max-w-sm shadow-2xl rounded-3xl">
            <h3 className="text-xl font-black uppercase mb-8 text-center text-white">Adjust Link Status</h3>
            <div className="space-y-6">
              <button 
                onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shifts', editingShift.id), { confirmed: !editingShift.confirmed })} 
                className={`w-full py-4 rounded-xl font-black text-xs uppercase transition-all ${editingShift.confirmed ? 'bg-cyan-600 text-white shadow-[0_0_15px_rgba(6,182,212,0.4)]' : 'bg-rose-600 text-white shadow-[0_0_15px_rgba(225,29,72,0.4)]'}`}
              >
                {editingShift.confirmed ? 'Link: Verified Active' : 'Link: Signal Lost'}
              </button>
              <input type="time" value={editingShift.time} onChange={e => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shifts', editingShift.id), { time: e.target.value })} className="w-full bg-black border border-white/10 rounded-xl p-4 text-3xl text-white font-black text-center" />
              <div className="flex gap-3">
                <button onClick={() => setEditingShift(null)} className="flex-1 bg-white text-black py-4 rounded-xl font-black uppercase text-xs hover:bg-cyan-400 transition-colors">Commit</button>
                <button onClick={async () => { if(confirm("Terminate link?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shifts', editingShift.id)); setEditingShift(null); } }} className="bg-rose-600 px-8 py-4 rounded-xl text-white hover:bg-rose-500"><TrashIcon /></button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
