<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destiny Springs | Hub Matrix</title>
    <!-- System Engines -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Compat Mode for single-file integration) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        * { font-style: normal !important; scrollbar-width: none; }
        ::-webkit-scrollbar { display: none; }
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; overflow: hidden; }
        
        .glass-panel { background: rgba(255,255,255,0.02); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; }
        .neon-blue { border: 1px solid rgba(0, 243, 255, 0.4); box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.05); }
        .neon-fuchsia { border: 1px solid rgba(255, 0, 255, 0.4); box-shadow: inset 0 0 20px rgba(255, 0, 255, 0.05); }
        .holo-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        
        .alert-pulse { animation: alert-glow 2s infinite; }
        .status-pulse { animation: status-glow 1.5s infinite; }
        @keyframes alert-glow { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
        @keyframes status-glow { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .calendar-grid { border: 1px solid black !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ADMIN CONFIGURATION ---
        const ADMIN_CODE = 'admin123'; // Change this to your desired admin password

        // --- ICON SUITE ---
        const IconCalendar = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const IconSync = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>;
        const IconPersonnel = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>;
        const IconPlus = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconAlert = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const IconChevronL = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>;
        const IconChevronR = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>;
        const IconLock = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const IconTrash = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const IconActivity = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>;
        const IconTerminal = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>;

        // --- FIREBASE CORE CONFIG ---
        // Allow Firebase config to be injected via window.__firebase_config or localStorage
        let firebaseConfig;
        try {
            if (window.__firebase_config) {
                firebaseConfig = typeof window.__firebase_config === 'string' 
                    ? JSON.parse(window.__firebase_config) 
                    : window.__firebase_config;
            } else if (localStorage.getItem('firebase_config')) {
                firebaseConfig = JSON.parse(localStorage.getItem('firebase_config'));
            } else {
                // Fallback to default config (without API key for security)
                firebaseConfig = {
                    apiKey: "",
                    authDomain: "reception-calendar-1.firebaseapp.com",
                    projectId: "reception-calendar-1",
                    storageBucket: "reception-calendar-1.appspot.com",
                    messagingSenderId: "613158953901",
                    appId: "1:613158953901:web:ed3f0a6cc4cb23f65df724"
                };
            }
        } catch (e) {
            console.error("Firebase config parsing error:", e);
            firebaseConfig = {
                apiKey: "",
                authDomain: "reception-calendar-1.firebaseapp.com",
                projectId: "reception-calendar-1",
                storageBucket: "reception-calendar-1.appspot.com",
                messagingSenderId: "613158953901",
                appId: "1:613158953901:web:ed3f0a6cc4cb23f65df724"
            };
        }
        
        const activeAppId = "destiny-springs-hub";
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const REPORT_FIELDS = [
            { id: 'mail', label: 'Mail / Deliveries' }, 
            { id: 'property', label: 'Patient Property' },
            { id: 'supplies', label: 'Hub Supplies' }, 
            { id: 'lobby', label: 'Lobby Status' },
            { id: 'aoc', label: 'AOC Status' }
        ];

        // --- DEMO/OFFLINE FALLBACK DATA ---
        const DEMO_STAFF = {
            'demo-karen': { id: 'demo-karen', name: 'Karen (Demo)', bg: 'bg-cyan-600/80' },
            'demo-izzy': { id: 'demo-izzy', name: 'Izzy (Demo)', bg: 'bg-rose-600/80' },
            'demo-annalissia': { id: 'demo-annalissia', name: 'Annalissia (Demo)', bg: 'bg-fuchsia-600/80' },
            'demo-hal': { id: 'demo-hal', name: 'Hal (Demo)', bg: 'bg-blue-600/80' }
        };

        const DEMO_MESSAGES = [
            { id: 'demo-1', text: 'System running in demo mode', user: 'SYS', createdAt: Date.now() - 3000 },
            { id: 'demo-2', text: 'Sample message from reception desk', user: 'DEMO', createdAt: Date.now() - 2000 },
            { id: 'demo-3', text: 'Configure Firebase to enable live data', user: 'INFO', createdAt: Date.now() - 1000 }
        ];

        function generateDemoShifts() {
            const shifts = {};
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dow = date.getDay();
                
                // Create sample shifts based on day of week
                if (dow === 1 || dow === 3) { // Mon, Wed
                    shifts[dateKey] = [{ id: `demo-shift-${d}-1`, date: dateKey, empId: 'demo-karen', time: '08:00', confirmed: true }];
                } else if (dow === 2 || dow === 4 || dow === 5) { // Tue, Thu, Fri
                    shifts[dateKey] = [{ id: `demo-shift-${d}-2`, date: dateKey, empId: 'demo-izzy', time: '08:00', confirmed: true }];
                } else if (dow === 0) { // Sunday
                    shifts[dateKey] = [
                        { id: `demo-shift-${d}-3`, date: dateKey, empId: 'demo-hal', time: '16:00', confirmed: true },
                        { id: `demo-shift-${d}-4`, date: dateKey, empId: 'demo-annalissia', time: '08:00', confirmed: true }
                    ];
                }
            }
            return shifts;
        }

        function App() {
            // --- Matrix State ---
            const [user, setUser] = useState(null);
            const [apiDisabled, setApiDisabled] = useState(false);
            const [handshakeFailed, setHandshakeFailed] = useState(false);
            const [isOfflineMode, setIsOfflineMode] = useState(false);
            const [currentDate, setCurrentDate] = useState(() => {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), 1);
            });
            const [selectedDate, setSelectedDate] = useState(() => new Date().toISOString().split('T')[0]);
            const [events, setEvents] = useState({});
            const [staff, setStaff] = useState({});
            const [messages, setMessages] = useState([]);
            const [reportData, setReportData] = useState({});
            const [globalAlert, setGlobalAlert] = useState('');
            const [isPersonnelModalOpen, setIsPersonnelModalOpen] = useState(false);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [editingShift, setEditingShift] = useState(null);
            const [adminCode, setAdminCode] = useState('');
            const [isAdminAuth, setIsAdminAuth] = useState(false);
            const [chatInput, setChatInput] = useState('');
            const [newStaffName, setNewStaffName] = useState('');
            const chatEndRef = useRef(null);

            // --- Initialize Demo Data on Offline Mode ---
            useEffect(() => {
                if (isOfflineMode) {
                    setEvents(generateDemoShifts());
                    setStaff(DEMO_STAFF);
                    setMessages(DEMO_MESSAGES);
                    setGlobalAlert('OFFLINE DEMO MODE - Configure Firebase to enable live data');
                }
            }, [isOfflineMode]);

            // --- Robust Error Interceptor ---
            function catchSystemError(e) {
                console.error("Matrix Logic Error Interceptor:", e);
                const msg = (e.message || "").toLowerCase();
                const code = (e.code || "").toLowerCase();
                
                if (msg.includes('api has not been used') || 
                    code === 'permission-denied' || 
                    msg.includes('disabled') || 
                    msg.includes('could not reach cloud firestore backend')) {
                    setApiDisabled(true);
                    setIsOfflineMode(true);
                }
            }

            // --- Admin Master Reset Pattern ---
            async function handleMasterReset() {
                if (!user) return;
                if (!confirm("ADMIN MASTER RESET: Restore personnel Karen, Izzy, Annalissia, and Hal and force February Baseline schedule?")) return;
                
                try {
                    const batch = db.batch();
                    const baseRef = db.collection('artifacts').doc(activeAppId).collection('public').doc('data');
                    
                    const coreTeam = [
                        { id: 'unit-karen', name: 'Karen', bg: 'bg-cyan-600/80' },
                        { id: 'unit-izzy', name: 'Izzy', bg: 'bg-rose-600/80' },
                        { id: 'unit-annalissia', name: 'Annalissia', bg: 'bg-fuchsia-600/80' },
                        { id: 'unit-hal', name: 'Hal', bg: 'bg-blue-600/80' }
                    ];

                    coreTeam.forEach(m => {
                        batch.set(baseRef.collection('staff').doc(m.id), { ...m, createdAt: Date.now() }, { merge: true });
                    });

                    for (let d = 1; d <= 28; d++) {
                        const dk = `2026-02-${String(d).padStart(2, '0')}`;
                        const dow = new Date(2026, 1, d).getDay();
                        const shiftRef = baseRef.collection('shifts').doc();
                        
                        if (dow === 1 || dow === 3) { // Mon, Wed
                            batch.set(shiftRef, { date: dk, empId: 'unit-karen', time: '08:00', confirmed: true, createdAt: Date.now() });
                        } else if (dow === 2 || dow === 4 || dow === 5) { // Tue, Thu, Fri
                            batch.set(shiftRef, { date: dk, empId: 'unit-izzy', time: '08:00', confirmed: true, createdAt: Date.now() });
                        } else if (dow === 0 && d === 1) { // Sunday Reset
                            batch.set(shiftRef, { date: dk, empId: 'unit-hal', time: '16:00', confirmed: true, createdAt: Date.now() });
                            batch.set(baseRef.collection('shifts').doc(), { date: dk, empId: 'unit-annalissia', time: '08:00', confirmed: true, createdAt: Date.now() });
                        }
                    }
                    await batch.commit();
                } catch (e) { catchSystemError(e); }
            }

            // --- Handshake Sequence ---
            useEffect(() => {
                const establishHandshake = async () => {
                    try {
                        const credential = await auth.signInAnonymously();
                        setUser(credential.user);
                    } catch (e) { 
                        catchSystemError(e);
                        setHandshakeFailed(true);
                        setIsOfflineMode(true);
                    }
                };
                establishHandshake();
                const unsub = auth.onAuthStateChanged(u => setUser(u));
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const base = db.collection('artifacts').doc(activeAppId).collection('public').doc('data');

                const unsubShifts = base.collection('shifts').onSnapshot(snap => {
                    const d = {}; snap.forEach(doc => {
                        const s = doc.data(); if (!d[s.date]) d[s.date] = [];
                        d[s.date].push({ ...s, id: doc.id });
                    }); setEvents(d);
                }, catchSystemError);

                const unsubStaff = base.collection('staff').onSnapshot(snap => {
                    const l = {}; snap.forEach(doc => { l[doc.id] = doc.data(); });
                    setStaff(l);
                }, catchSystemError);

                const unsubMsgs = base.collection('messages').onSnapshot(snap => {
                    const msgs = []; snap.forEach(doc => msgs.push({ ...doc.data(), id: doc.id }));
                    setMessages(msgs.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0)));
                    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }, catchSystemError);

                const unsubAlert = base.collection('alerts').doc('current').onSnapshot(snap => {
                    if (snap.exists) setGlobalAlert(snap.data().text);
                });

                return () => { unsubShifts(); unsubStaff(); unsubMsgs(); unsubAlert(); };
            }, [user]);

            useEffect(() => {
                if (!user || !selectedDate) return;
                const unsub = db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('dailyReports').doc(selectedDate)
                    .onSnapshot(snap => setReportData(snap.data() || {}), catchSystemError);
                return () => unsub();
            }, [user, selectedDate]);

            // --- UI Elements ---
            const calendarMatrix = useMemo(() => {
                const mIdx = currentDate.getMonth(), yIdx = currentDate.getFullYear();
                const total = new Date(yIdx, mIdx + 1, 0).getDate();
                const start = new Date(yIdx, mIdx, 1).getDay();
                const cells = [];
                // CALENDAR TALLER: min-h bumped to 180px
                for (let i = 0; i < start; i++) cells.push(<div key={`e-${i}`} className="min-h-[180px] bg-white/[0.01] border border-white/[0.03]" />);
                for (let d = 1; d <= total; d++) {
                    const dk = `${yIdx}-${String(mIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayShifts = events[dk] || [];
                    const isToday = new Date().toISOString().split('T')[0] === dk;
                    cells.push(
                        <div key={dk} onClick={() => setSelectedDate(dk)} className={`min-h-[180px] p-3 border border-white/[0.05] transition-all cursor-pointer relative group ${selectedDate === dk ? 'bg-cyan-500/10 ring-1 ring-cyan-400 shadow-inner' : 'bg-white/[0.01] hover:bg-white/[0.03]'} ${isToday ? 'border-l-2 border-l-cyan-400' : ''}`}>
                            <div className="flex justify-between items-start">
                                <span className={`text-xl font-black tracking-tighter ${selectedDate === dk ? 'text-cyan-400' : 'text-slate-600'}`}>{d}</span>
                                {!isOfflineMode && <button onClick={(e) => { e.stopPropagation(); setSelectedDate(dk); setIsAddModalOpen(true); }} className="p-1 opacity-20 hover:opacity-100 transition-opacity"><IconPlus /></button>}
                            </div>
                            <div className="space-y-2 mt-4">
                                {dayShifts.length === 0 ? <div className="text-[10px] font-black text-rose-500 animate-pulse uppercase flex items-center gap-1 mt-2 text-left font-mono italic"><IconAlert /> Needs Coverage</div> : 
                                    dayShifts.map(s => (
                                        <div key={s.id} onClick={(e) => { if (!isOfflineMode) { e.stopPropagation(); setEditingShift(s); } }} 
                                            className={`text-[13px] p-2 rounded-xl font-bold truncate text-white ${staff[s.empId]?.bg || 'bg-slate-700'} uppercase flex items-center justify-between text-left shadow-2xl border border-white/10 ${isOfflineMode ? '' : 'group-hover:scale-105 transition-transform cursor-pointer'}`}>
                                            <span>{staff[s.empId]?.name || '...'}</span>
                                            <span className="opacity-50 text-[10px] font-mono shrink-0">{s.time}</span>
                                        </div>
                                    ))
                                }
                            </div>
                        </div>
                    );
                }
                return cells;
            }, [currentDate, events, selectedDate, staff]);

            // --- API DISABLED DASHBOARD ---
            if (apiDisabled || handshakeFailed) {
                // If already in offline mode, skip the error screen and show the app with demo data
                if (isOfflineMode && (Object.keys(staff).length > 0 || Object.keys(events).length > 0)) {
                    // Continue to render the main app below
                } else {
                    return (
                        <div className="h-screen bg-black flex flex-col items-center justify-center p-10 text-center gap-8">
                            <div className="text-rose-500 font-black text-5xl alert-pulse uppercase tracking-[0.3em] holo-text">Protocol_Blocked</div>
                            <div className="glass-panel p-10 border border-rose-500/30 max-w-2xl text-left shadow-2xl rounded-[2rem]">
                                <p className="text-rose-400 font-black text-lg mb-8 uppercase tracking-widest flex items-center gap-3"><IconAlert /> Matrix Database Offline</p>
                                <p className="text-sm text-slate-300 leading-relaxed mb-6 italic">The Cloud Firestore API is disabled for project: <span className="font-mono text-white underline">reception-calendar-1</span>. Follow these steps to restore the signal:</p>
                                <div className="space-y-6 text-sm text-slate-200">
                                    <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                                        <p className="font-black text-cyan-400 mb-2 uppercase text-[10px] tracking-widest font-bold">1. Open Console Link:</p>
                                        <a href="https://console.developers.google.com/apis/api/firestore.googleapis.com/overview?project=reception-calendar-1" target="_blank" className="text-xs font-mono text-white underline break-all">https://console.developers.google.com/apis/api/firestore.googleapis.com/overview?project=reception-calendar-1</a>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                                        <p className="font-black text-cyan-400 mb-2 uppercase text-[10px] tracking-widest font-bold">2. Enable Database API:</p>
                                        <p>Click the big blue <span className="bg-blue-600 px-3 py-1 rounded text-[10px] font-black uppercase text-white shadow-lg font-bold tracking-widest">Enable</span> button on the Google page.</p>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-lg border border-white/10">
                                        <p className="font-black text-cyan-400 mb-2 uppercase text-[10px] tracking-widest font-bold">3. Matrix Re-Sync:</p>
                                        <p>Wait 60 seconds after enabling, return here, and refresh the browser page.</p>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <button onClick={() => window.location.reload()} className="bg-white text-black px-12 py-4 rounded-2xl font-black uppercase text-xs shadow-xl transition-all hover:scale-105 active:scale-95 font-bold tracking-widest">Retry Handshake</button>
                                <button onClick={() => { setIsOfflineMode(true); setEvents(generateDemoShifts()); setStaff(DEMO_STAFF); setMessages(DEMO_MESSAGES); setGlobalAlert('OFFLINE DEMO MODE - Configure Firebase to enable live data'); }} className="bg-cyan-600 text-white px-12 py-4 rounded-2xl font-black uppercase text-xs shadow-xl transition-all hover:scale-105 active:scale-95 font-bold tracking-widest">View Demo Mode</button>
                            </div>
                        </div>
                    );
                }
            }

            if (!user && !isOfflineMode) return <div className="h-screen bg-black flex flex-col items-center justify-center text-cyan-400 font-black animate-pulse uppercase tracking-widest text-center gap-4">
                <div className="text-4xl holo-text tracking-[0.2em]">establishing_link...</div>
                <div className="text-[10px] opacity-40">Matrix Core Handshake Active</div>
            </div>;

            return (
                <div className="flex h-screen w-screen bg-black overflow-hidden text-xs">
                    {/* OFFLINE MODE BANNER */}
                    {isOfflineMode && (
                        <div className="fixed top-0 left-0 right-0 z-[700] bg-amber-600/90 backdrop-blur-sm border-b border-amber-400 py-2 px-6 flex items-center justify-center gap-3 text-black font-black text-xs uppercase tracking-widest no-print">
                            <IconAlert />
                            <span>Demo Mode Active - Viewing Sample Data Only</span>
                            <button onClick={() => window.location.reload()} className="ml-4 bg-black text-amber-400 px-4 py-1 rounded-lg hover:bg-amber-900 transition-colors">Retry Connection</button>
                        </div>
                    )}
                    {/* NAV RAIL */}
                    <nav className="no-print w-16 bg-[#050505] border-r border-white/5 flex flex-col items-center py-8 gap-10">
                        <div className="text-cyan-400 font-black text-xl holo-text">DS</div>
                        <button onClick={handleMasterReset} disabled={isOfflineMode} className={`p-3 bg-cyan-500/10 rounded-xl border border-cyan-500/30 transition-all shadow-inner ${isOfflineMode ? 'opacity-30 cursor-not-allowed' : 'hover:scale-110'}`} title="Admin Master Reset"><IconSync /></button>
                        <button onClick={() => setIsPersonnelModalOpen(true)} disabled={isOfflineMode} className={`p-3 bg-fuchsia-500/10 rounded-xl border border-fuchsia-500/30 transition-all ${isOfflineMode ? 'opacity-30 cursor-not-allowed' : 'hover:scale-110'}`} title="Personnel Manifest"><IconPersonnel /></button>
                        <div className="mt-auto flex flex-col items-center gap-3">
                            <div className={`w-2.5 h-2.5 rounded-full status-pulse ${user ? 'bg-emerald-500 shadow-[0_0_10px_#10b981]' : 'bg-amber-500'}`} />
                            <div className="opacity-10 text-[8px] font-black uppercase rotate-90 tracking-widest font-mono">Protocol</div>
                        </div>
                    </nav>

                    <div className="flex-1 flex flex-col">
                        <header className="no-print h-10 bg-rose-950/20 border-b border-rose-500/30 flex items-center px-6 gap-4 text-left font-bold">
                            <div className="flex items-center gap-2 text-rose-500 font-black text-[9px] uppercase tracking-widest alert-pulse shrink-0"><IconAlert /> Critical Intel</div>
                            <input value={globalAlert} onChange={e => { if (!isOfflineMode) { setGlobalAlert(e.target.value); db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('alerts').doc('current').set({ text: String(e.target.value) }); } }} disabled={isOfflineMode} className="flex-1 bg-transparent border-none text-[11px] font-bold text-white outline-none placeholder-rose-900 disabled:opacity-60" placeholder={isOfflineMode ? "Offline - Demo Mode" : "Broadcast immediate hub directive..."} />
                        </header>

                        <div className="flex-1 flex overflow-hidden">
                            {/* SIDEBAR LOGS */}
                            <aside className="no-print w-80 bg-[#080808] border-r border-white/5 p-5 flex flex-col gap-4 overflow-y-auto no-scrollbar">
                                <header className="text-left mb-2 text-white font-black">
                                    <h1 className="text-lg tracking-tighter holo-text uppercase">Archive Logs</h1>
                                    <div className="text-[10px] text-cyan-400 font-bold uppercase mt-1 tracking-widest font-mono">{selectedDate}</div>
                                </header>
                                <div className="space-y-3">
                                    {REPORT_FIELDS.map(f => (
                                        <div key={f.id} className="glass-panel neon-fuchsia p-3 text-left font-bold">
                                            <label className="text-[9px] font-black text-fuchsia-400 uppercase tracking-widest mb-1 block flex items-center gap-2 font-bold font-mono"><IconActivity /> {f.label}</label>
                                            <textarea value={String(reportData[f.id] || '')} onChange={e => { if(!user || isOfflineMode)return; db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('dailyReports').doc(selectedDate).set({ [f.id]: e.target.value }, { merge: true }); }} disabled={isOfflineMode} className="w-full bg-transparent border-none text-xs text-white h-14 outline-none resize-none font-bold disabled:opacity-60" placeholder={isOfflineMode ? "Demo mode" : "..."} />
                                        </div>
                                    ))}
                                </div>
                                <div className="glass-panel neon-blue p-3 rounded-lg mt-auto text-left flex flex-col h-48">
                                    <label className="text-[9px] font-black text-cyan-400 uppercase tracking-widest mb-2 block flex items-center gap-2 font-mono tracking-widest font-bold"><IconTerminal className="inline mr-2"/>Live Intel Feed</label>
                                    <div className="flex-1 overflow-y-auto space-y-1.5 mb-2 text-[10px] no-scrollbar text-slate-300 font-medium">
                                        {messages.map(m => <div key={m.id}><span className="text-cyan-500 font-black mr-1 uppercase">{String(m.user)}:</span>{String(m.text)}</div>)}
                                        <div ref={chatEndRef} />
                                    </div>
                                    <form onSubmit={e => { e.preventDefault(); if (!isOfflineMode && chatInput.trim()) { db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('messages').add({ text: chatInput, createdAt: Date.now(), user: user.uid.slice(-4) }); setChatInput(''); } }} className="flex gap-1 shrink-0 pt-2 text-left">
                                        <input value={chatInput} onChange={e => setChatInput(e.target.value)} disabled={isOfflineMode} className="flex-1 bg-black border border-cyan-500/30 rounded p-1.5 text-[10px] outline-none text-white font-bold disabled:opacity-60" placeholder={isOfflineMode ? "Demo mode" : "Broadcast..."} />
                                        <button type="submit" disabled={isOfflineMode} className="bg-cyan-600 px-2 rounded text-white font-bold transition-all hover:bg-cyan-500 uppercase font-black tracking-widest disabled:opacity-30 disabled:cursor-not-allowed">OK</button>
                                    </form>
                                </div>
                            </aside>

                            {/* MAIN GRID */}
                            <main className="flex-1 p-8 overflow-y-auto no-scrollbar text-center font-bold">
                                <div className="flex justify-between items-end mb-8 no-print text-left font-bold">
                                    <div className="text-white">
                                        <h2 className="text-5xl font-black uppercase tracking-tighter drop-shadow-[0_0_15px_rgba(255,255,255,0.2)] font-black">
                                            {currentDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' })}
                                        </h2>
                                        <div className="text-[10px] font-black text-cyan-400 tracking-[0.5em] uppercase mt-1">Matrix Interface Alpha</div>
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex bg-white/5 rounded-xl border border-white/10 p-1 text-white font-bold">
                                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 hover:text-cyan-400 transition-colors border-r border-white/5 uppercase font-bold text-[10px]"><IconChevronL /></button>
                                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 hover:text-cyan-400 transition-colors uppercase font-bold text-[10px]"><IconChevronR /></button>
                                        </div>
                                        <button onClick={() => window.print()} className="bg-cyan-500 text-black px-6 py-2 rounded-xl font-black text-xs uppercase shadow-lg hover:bg-white transition-all font-bold">Export Matrix</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 glass-panel overflow-hidden neon-blue rounded-xl font-bold">
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => <div key={d} className="py-4 text-center text-[10px] font-black text-cyan-400/60 uppercase tracking-widest border-b border-white/5 bg-white/[0.02]">{d}</div>)}
                                    {calendarMatrix}
                                </div>
                            </main>
                        </div>
                    </div>

                    {/* MODAL: PERSONNEL */}
                    {isPersonnelModalOpen && (
                        <div className="fixed inset-0 bg-black/98 backdrop-blur-2xl z-[600] flex items-center justify-center p-4">
                            <div className="glass-panel neon-fuchsia p-10 w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl rounded-[2rem]">
                                <div className="flex justify-between items-center mb-8 text-fuchsia-400 text-left">
                                    <h3 className="text-3xl font-black uppercase tracking-tighter">Manifest Hub</h3>
                                    <button onClick={() => { setIsPersonnelModalOpen(false); setIsAdminAuth(false); }} className="text-5xl font-light hover:text-white transition-colors">&times;</button>
                                </div>
                                {!isAdminAuth ? (
                                    <form onSubmit={e => { e.preventDefault(); if (adminCode === ADMIN_CODE) setIsAdminAuth(true); }} className="space-y-6 flex-1 flex flex-col justify-center items-center text-center font-bold">
                                        <div className="text-fuchsia-500 font-black text-xl flex items-center gap-3 alert-pulse">Restricted Access<br/><span className="text-[10px] opacity-40 uppercase tracking-widest font-bold font-mono"><IconLock className="inline mr-2"/> Code Required</span></div>
                                        <input type="password" value={adminCode} onChange={e => setAdminCode(e.target.value)} className="w-48 bg-black border border-fuchsia-500/40 rounded-xl p-4 text-center text-3xl text-white outline-none shadow-inner font-black" placeholder="****" autoFocus />
                                        <button type="submit" className="bg-fuchsia-600 px-12 py-3 rounded-xl font-black uppercase text-xs text-white shadow-lg transition-all hover:scale-105 active:scale-95 font-bold tracking-widest">Unlock Manifest</button>
                                    </form>
                                ) : (
                                    <div className="flex flex-col flex-1 overflow-hidden text-left font-bold">
                                        <div className="space-y-4 mb-8 text-white text-left font-bold font-mono">
                                            <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Enroll New Unit</label>
                                            <div className="flex gap-3">
                                                <input value={newStaffName} onChange={e => setNewStaffName(e.target.value)} className="flex-1 bg-black border border-white/10 rounded-xl p-3 text-sm text-white font-black outline-none focus:border-fuchsia-500 font-bold" placeholder="Identity Label..." />
                                                <button onClick={async () => { if (!newStaffName.trim()) return; await db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('staff').add({ name: String(newStaffName), bg: 'bg-slate-700', createdAt: Date.now() }); setNewStaffName(''); }} className="bg-fuchsia-600 px-6 rounded-xl font-black uppercase text-xs text-white shadow-lg transition-all hover:bg-fuchsia-500 font-bold tracking-widest">Enroll</button>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-2 pr-2 border-t border-white/5 pt-4 text-white text-left font-bold">
                                            {Object.entries(staff).map(([id, s]) => (
                                                <div key={id} className="flex items-center justify-between p-3 glass-panel neon-blue rounded-xl group border-white/5 transition-all hover:bg-white/[0.03]">
                                                    <div className="flex items-center gap-4 text-left font-bold font-mono">
                                                        <div className={`w-3 h-3 rounded-full ${s.bg || 'bg-slate-700'} shadow-white/20`} />
                                                        <span className="font-black uppercase text-sm">{String(s.name)}</span>
                                                    </div>
                                                    <button onClick={async () => { if(confirm("Terminate unit identifier?")) await db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('staff').doc(id).delete(); }} className="text-rose-500 font-black text-[9px] uppercase px-3 py-1 hover:bg-rose-500/10 rounded-lg border border-rose-500/30 font-mono font-bold tracking-widest">PURGE</button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* ASSIGN MODAL */}
                    {isAddModalOpen && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[500] flex items-center justify-center p-4 text-left font-bold text-white">
                            <div className="glass-panel neon-blue p-10 w-full max-w-md shadow-2xl rounded-3xl">
                                <h3 className="text-2xl font-black text-cyan-400 uppercase mb-8 tracking-tighter text-left font-mono font-bold">Deploy Identity</h3>
                                <div className="grid grid-cols-2 gap-2 mb-8">
                                    {Object.entries(staff).map(([id, s]) => <button key={id} onClick={() => {
                                        db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('shifts').add({
                                            date: selectedDate, empId: id, time: '08:00', confirmed: true, createdAt: Date.now()
                                        }); setIsAddModalOpen(false);
                                    }} className={`p-4 rounded-xl text-[14px] font-black uppercase text-white ${s.bg || 'bg-slate-700'} hover:scale-105 transition-all shadow-lg font-black`}>{String(s.name)}</button>)}
                                </div>
                                <button onClick={() => setIsAddModalOpen(false)} className="w-full text-slate-600 text-[10px] font-black uppercase tracking-[0.2em] pt-6 text-center hover:text-white transition-colors underline font-bold tracking-widest">Cancel deployment</button>
                            </div>
                        </div>
                    )}

                    {/* EDIT MODAL */}
                    {editingShift && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[500] flex items-center justify-center p-4">
                            <div className="glass-panel neon-fuchsia p-8 w-full max-w-sm shadow-2xl rounded-3xl text-left font-bold text-white">
                                <h3 className="text-xl font-black uppercase mb-8 text-center text-white tracking-tighter font-bold font-mono tracking-widest">Adjust Link</h3>
                                <div className="space-y-6 text-center font-bold">
                                    <button onClick={() => db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('shifts').doc(editingShift.id).update({ confirmed: !editingShift.confirmed })} className={`w-full py-4 rounded-xl font-black text-xs uppercase transition-all ${editingShift.confirmed ? 'bg-cyan-600 text-white shadow-[0_0_15px_rgba(6,182,212,0.4)]' : 'bg-rose-600 text-white shadow-[0_0_15px_rgba(225,29,72,0.4)]'}`}>{editingShift.confirmed ? 'Link: Verified' : 'Link: Lost'}</button>
                                    <div className="flex gap-3 font-bold">
                                        <button onClick={() => setEditingShift(null)} className="flex-1 bg-white text-black py-4 rounded-xl font-black uppercase text-xs hover:bg-cyan-400 transition-colors shadow-lg font-bold tracking-widest">Commit</button>
                                        <button onClick={async () => { if(confirm("Terminate link?")) { await db.collection('artifacts').doc(activeAppId).collection('public').doc('data').collection('shifts').doc(editingShift.id).delete(); setEditingShift(null); } }} className="bg-rose-600 px-8 py-4 rounded-xl text-white hover:bg-rose-500 shadow-lg font-bold"><IconTrash /></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
